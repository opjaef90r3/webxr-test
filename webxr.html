<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <script>
      // Gun component
      AFRAME.registerComponent('gun', {
        init: function () {
          this.shooting = false;
          this.currentFireMode = 'semi';
          this.burstCount = 0;
          this.lastShootTime = 0;
          this.ammo = 30;
          this.maxAmmo = 30;
          this.isHeld = false;
          this.el.addEventListener('triggerdown', this.onTriggerDown.bind(this));
          this.el.addEventListener('triggerup', this.onTriggerUp.bind(this));
          this.el.addEventListener('bbuttondown', this.toggleFireMode.bind(this));
          this.el.addEventListener('gripdown', this.onGripDown.bind(this));
          this.el.addEventListener('gripup', this.onGripUp.bind(this));
          this.updateAmmoDisplay();
        },
        onTriggerDown: function () {
          if (this.isHeld) {
            this.shooting = true;
            this.shoot();
          }
        },
        onTriggerUp: function () {
          this.shooting = false;
          this.burstCount = 0;
        },
        onGripDown: function () {
          this.isHeld = !this.isHeld;
          if (this.isHeld) {
            this.el.setAttribute('visible', true);
            document.querySelector('#rightHand').appendChild(this.el);
            this.el.setAttribute('position', '0 0 -0.25');
            this.el.setAttribute('rotation', '0 0 0');
          } else {
            document.querySelector('#gunHolder').appendChild(this.el);
            this.el.setAttribute('position', '0.5 1 -0.5');
            this.el.setAttribute('rotation', '0 0 0');
          }
        },
        onGripUp: function () {
          // Do nothing, as we want to toggle on grip down only
        },
        toggleFireMode: function () {
          const modes = ['semi', 'burst', 'auto'];
          const currentIndex = modes.indexOf(this.currentFireMode);
          this.currentFireMode = modes[(currentIndex + 1) % modes.length];
          console.log('Fire mode: ' + this.currentFireMode);
        },
        shoot: function () {
          if (!this.shooting || this.ammo <= 0) return;
          
          const now = Date.now();
          if (now - this.lastShootTime < 100) return;
          
          this.lastShootTime = now;
          this.ammo--;
          this.updateAmmoDisplay();
          
          this.el.emit('shoot');
          
          if (this.currentFireMode === 'semi') {
            this.shooting = false;
          } else if (this.currentFireMode === 'burst') {
            this.burstCount++;
            if (this.burstCount >= 3) {
              this.shooting = false;
              this.burstCount = 0;
            }
          }
          
          if (this.shooting) {
            setTimeout(() => this.shoot(), this.currentFireMode === 'auto' ? 100 : 50);
          }
        },
        updateAmmoDisplay: function () {
          const ammoDisplay = document.querySelector('#ammoDisplay');
          if (ammoDisplay) {
            ammoDisplay.setAttribute('value', `Ammo: ${this.ammo}/${this.maxAmmo}`);
          }
        }
      });

      // Target component
      AFRAME.registerComponent('target', {
        schema: {
          health: {type: 'int', default: 100}
        },
        init: function () {
          this.currentHealth = this.data.health;
          this.el.addEventListener('hit', this.onHit.bind(this));
        },
        onHit: function (evt) {
          this.currentHealth -= 10;
          if (this.currentHealth <= 0) {
            this.el.setAttribute('visible', 'false');
            document.querySelector('#score').setAttribute('value', parseInt(document.querySelector('#score').getAttribute('value')) + 1);
            setTimeout(() => {
              this.currentHealth = this.data.health;
              this.el.setAttribute('visible', 'true');
            }, 2000);
          } else {
            this.el.setAttribute('material', 'color', 'red');
            setTimeout(() => {
              this.el.setAttribute('material', 'color', this.el.getAttribute('data-original-color'));
            }, 100);
          }
        }
      });

      // Bullet component
      AFRAME.registerComponent('bullet', {
        init: function () {
          this.el.addEventListener('collide', this.onCollide.bind(this));
          setTimeout(() => {
            if (this.el.parentNode) {
              this.el.parentNode.removeChild(this.el);
            }
          }, 5000);
        },
        onCollide: function (evt) {
          if (evt.detail.body.el.getAttribute('target')) {
            evt.detail.body.el.emit('hit');
          }
          this.el.parentNode.removeChild(this.el);
        }
      });

      // Sound generator component
      AFRAME.registerComponent('sound-generator', {
        init: function () {
          this.audioContext = null;
          this.isInitialized = false;
          document.body.addEventListener('click', () => this.initAudio(), { once: true });
        },
        initAudio: function () {
          if (this.isInitialized) return;
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.isInitialized = true;
        },
        playShootSound: function () {
          if (!this.isInitialized) return;
          const oscillator = this.audioContext.createOscillator();
          oscillator.type = 'square';
          oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
          
          const gainNode = this.audioContext.createGain();
          gainNode.gain.setValueAtTime(1, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.2);
        },
        playHitSound: function () {
          if (!this.isInitialized) return;
          const oscillator = this.audioContext.createOscillator();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime);
          
          const gainNode = this.audioContext.createGain();
          gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.1);
        }
      });

      // Advanced movement component
      AFRAME.registerComponent('advanced-movement', {
        schema: {
          speed: {type: 'number', default: 40},
          rotationSpeed: {type: 'number', default: 2}
        },
        init: function () {
          this.velocity = new THREE.Vector3();
          this.rotation = new THREE.Euler();
          
          this.leftHand = document.querySelector('#leftHand');
          this.rightHand = document.querySelector('#rightHand');
          
          this.leftHand.addEventListener('thumbstickmoved', this.onLeftThumbstickMoved.bind(this));
          this.rightHand.addEventListener('thumbstickmoved', this.onRightThumbstickMoved.bind(this));
        },
        onLeftThumbstickMoved: function (evt) {
          this.velocity.x = evt.detail.x * this.data.speed;
          this.velocity.z = -evt.detail.y * this.data.speed;
        },
        onRightThumbstickMoved: function (evt) {
          this.rotation.y = -evt.detail.x * this.data.rotationSpeed;
        },
        tick: function (time, timeDelta) {
          const deltaSeconds = timeDelta / 1000;
          const cameraRotation = this.el.querySelector('[camera]').object3D.rotation;
          
          const movementVector = new THREE.Vector3(this.velocity.x, 0, this.velocity.z);
          movementVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraRotation.y);
          
          this.el.object3D.position.add(movementVector.multiplyScalar(deltaSeconds));
          this.el.object3D.rotateY(this.rotation.y * deltaSeconds);
        }
      });
    </script>
  </head>
  <body>
    <a-scene physics="debug: true" sound-generator>
      <a-assets>
        <!-- Add any necessary assets here -->
      </a-assets>

      <!-- Player rig -->
      <a-entity id="rig" position="0 0.8 0" advanced-movement="speed: 40; rotationSpeed: 2">
        <a-entity camera look-controls position="0 0 0"></a-entity>
        <a-entity id="leftHand" oculus-touch-controls="hand: left"></a-entity>
        <a-entity id="rightHand" oculus-touch-controls="hand: right"></a-entity>
      </a-entity>

      <!-- Gun holder -->
      <a-entity id="gunHolder" position="0.5 1 -0.5"></a-entity>

      <!-- Gun -->
      <a-entity id="gun" gun position="0.5 1 -0.5">
        <a-box material="color: #4d4d4d; metalness: 0.8; roughness: 0.2" depth="0.2" height="0.3" width="0.1"></a-box>
        <a-cylinder material="color: #1a1a1a; metalness: 0.9; roughness: 0.1" radius="0.02" height="0.4" position="0 0.1 -0.25" rotation="90 0 0"></a-cylinder>
        <a-box material="color: #4d4d4d; metalness: 0.8; roughness: 0.2" depth="0.05" height="0.15" width="0.1" position="0 -0.1 0.05"></a-box>
        <a-entity id="bulletSpawn" position="0 0.15 -0.45"></a-entity>
        <a-box material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 0.5" depth="0.02" height="0.02" width="0.02" position="0 0.2 -0.1"></a-box>
        <a-text value="LASER" position="0.06 0 0" rotation="0 -90 0" scale="0.1 0.1 0.1" color="#ff0000"></a-text>
      </a-entity>

      <!-- Environment -->
      <a-entity environment="preset: tron; groundColor: #0a0a0a; groundColor2: #0f0f0f; groundTexture: walkernoise; grid: 2x2; gridColor: #00ffff; horizonColor: #003366; skyColor: #000033; lighting: distant; lightPosition: 1 5 -2; fog: 0.7; dressing: towers; dressingAmount: 50; dressingColor: #00ffff; dressingScale: 50; dressingVariance: 20 20 20; dressingUniformScale: true; playArea: 100"></a-entity>

      <!-- Targets -->
      <a-entity id="targetGroup">
        <a-box class="target" target="health: 100" position="-10 1.5 -20" depth="0.5" height="0.5" width="0.5" material="color: #00ff00; emissive: #00ff00; emissiveIntensity: 0.2" animation="property: position; to: -10 1.5 -25; dir: alternate; dur: 5000; loop: true" data-original-color="#00ff00"></a-box>
        <a-sphere class="target" target="health: 150" position="0 2 -30" radius="0.4" material="color: #ff00ff; emissive: #ff00ff; emissiveIntensity: 0.2" animation="property: position; to: 0 2 -35; dir: alternate; dur: 4000; loop: true" data-original-color="#ff00ff"></a-sphere>
        <a-cylinder class="target" target="health: 200" position="10 1 -25" radius="0.3" height="1" material="color: #ffff00; emissive: #ffff00; emissiveIntensity: 0.2" animation="property: rotation; to: 0 360 0; dur: 3000; loop: true" data-original-color="#ffff00"></a-cylinder>
        <a-torus class="target" target="health: 250" position="-15 3 -40" radius="1" radius-tubular="0.1" material="color: #00ffff; emissive: #00ffff; emissiveIntensity: 0.2" animation="property: rotation; to: 360 360 0; dur: 6000; loop: true" data-original-color="#00ffff"></a-torus>
        <a-octahedron class="target" target="health: 300" position="15 4 -35" radius="0.7" material="color: #ff6600; emissive: #ff6600; emissiveIntensity: 0.2" animation="property: position; to: 15 6 -35; dir: alternate; dur: 3000; loop: true" data-original-color="#ff6600"></a-octahedron>
      </a-entity>

      <!-- UI Elements -->
      <a-text id="score" value="Score: 0" position="-0.75 1.5 -2" scale="0.5 0.5 0.5" color="white"></a-text>
      <a-text id="ammoDisplay" value="Ammo: 30/30" position="0.75 1.5 -2" scale="0.5 0.5 0.5" color="white"></a-text>
<a-text id="modeDisplay" value="Mode: Semi" position="0 1.7 -2" scale="0.5 0.5 0.5" color="white"></a-text>

      <!-- Additional Environment Objects -->
      <a-entity id="obstacles">
        <a-box position="-20 2 -30" width="4" height="4" depth="4" material="color: #45a5f5; metalness: 0.8; roughness: 0.2" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"></a-box>
        <a-torus position="20 3 -40" radius="3" radius-tubular="0.2" material="color: #ff9800; metalness: 0.6; roughness: 0.4" animation="property: rotation; to: 360 360 0; loop: true; dur: 8000"></a-torus>
        <a-octahedron position="0 5 -50" radius="2" material="color: #4caf50; metalness: 0.7; roughness: 0.3" animation="property: position; to: 0 8 -50; dir: alternate; loop: true; dur: 4000"></a-octahedron>
      </a-entity>

      <!-- Lighting -->
      <a-light type="ambient" color="#ffffff" intensity="0.2"></a-light>
      <a-light type="directional" color="#00ffff" intensity="0.6" position="-1 1 1"></a-light>
      <a-light type="point" color="#ff00ff" intensity="0.4" position="5 5 -10"></a-light>

      <!-- Particle systems for visual effects -->
      <a-entity position="0 10 -30" particle-system="preset: dust; particleCount: 5000; size: 0.5; color: #44ffff,#44ccff; accelerationValue: 0 -9.8 0; velocityValue: 0 15 0; velocitySpread: 10 7.5 10;"></a-entity>
    </a-scene>

    <script>
      var scene = document.querySelector('a-scene');
      var gun = document.querySelector('#gun');
      var bulletSpawn = document.querySelector('#bulletSpawn');
      var soundGenerator = scene.components['sound-generator'];
      var score = 0;

      gun.addEventListener('shoot', function () {
        var bullet = document.createElement('a-sphere');
        bullet.setAttribute('dynamic-body', '');
        bullet.setAttribute('bullet', '');
        bullet.setAttribute('radius', '0.05');
        bullet.setAttribute('material', 'color: #ffff00; emissive: #ffff00; emissiveIntensity: 0.5');
        
        var pos = new THREE.Vector3();
        var rot = new THREE.Quaternion();
        bulletSpawn.object3D.getWorldPosition(pos);
        bulletSpawn.object3D.getWorldQuaternion(rot);

        bullet.setAttribute('position', pos);
        
        var direction = new THREE.Vector3(0, 0, -1);
        direction.applyQuaternion(rot);
        direction.multiplyScalar(50);  // Increased bullet speed

        bullet.setAttribute('velocity', direction);
        scene.appendChild(bullet);
        soundGenerator.playShootSound();

        // Muzzle flash effect
        var muzzleFlash = document.createElement('a-entity');
        muzzleFlash.setAttribute('position', pos);
        muzzleFlash.setAttribute('particle-system', 'preset: spark; particleCount: 20; size: 0.2; color: #ffff00; blending: additive; maxAge: 0.1');
        scene.appendChild(muzzleFlash);
        setTimeout(() => scene.removeChild(muzzleFlash), 100);
      });

      scene.addEventListener('hit', function () {
        soundGenerator.playHitSound();
        score += 10;
        document.querySelector('#score').setAttribute('value', `Score: ${score}`);
      });

      // Reload function
      function reload() {
        var gunComponent = gun.components.gun;
        gunComponent.ammo = gunComponent.maxAmmo;
        gunComponent.updateAmmoDisplay();
        console.log('Reloaded');
      }

      // Add reload on 'Y' button press
      document.querySelector('#rightHand').addEventListener('ybuttondown', reload);

      // Update fire mode display
      gun.addEventListener('componentchanged', function(evt) {
        if (evt.detail.name === 'gun') {
          document.querySelector('#modeDisplay').setAttribute('value', `Mode: ${evt.detail.newData.currentFireMode}`);
        }
      });

      // Add some basic game loop logic
      var gameLoop = setInterval(function() {
        // Respawn targets that are not visible
        document.querySelectorAll('.target').forEach(function(target) {
          if (!target.getAttribute('visible')) {
            target.setAttribute('visible', 'true');
            target.components.target.currentHealth = target.components.target.data.health;
          }
        });

        // Spawn new targets periodically
        if (Math.random() < 0.1) {  // 10% chance each loop
          spawnNewTarget();
        }

        // Update difficulty based on score
        updateDifficulty();

      }, 5000);  // Run every 5 seconds

      function spawnNewTarget() {
        var shapes = ['a-box', 'a-sphere', 'a-cylinder', 'a-torus', 'a-octahedron'];
        var shape = shapes[Math.floor(Math.random() * shapes.length)];
        var target = document.createElement(shape);
        
        target.setAttribute('class', 'target');
        target.setAttribute('target', `health: ${100 + Math.floor(score / 100)}`);
        target.setAttribute('position', `${Math.random()*40-20} ${Math.random()*5+1} ${-30-Math.random()*30}`);
        target.setAttribute('material', `color: #${Math.floor(Math.random()*16777215).toString(16)}; emissive: #${Math.floor(Math.random()*16777215).toString(16)}; emissiveIntensity: 0.2`);
        target.setAttribute('animation', 'property: position; to: ' + target.getAttribute('position').x + ' ' + (parseFloat(target.getAttribute('position').y) + 2) + ' ' + target.getAttribute('position').z + '; dir: alternate; dur: ' + (2000 + Math.random() * 3000) + '; loop: true');
        
        document.querySelector('#targetGroup').appendChild(target);
      }

      function updateDifficulty() {
        var targets = document.querySelectorAll('.target');
        targets.forEach(function(target) {
          var currentSpeed = parseFloat(target.getAttribute('animation').dur);
          target.setAttribute('animation', 'dur', currentSpeed * 0.99);  // Increase speed by 1%
        });
      }
    </script>
  </body>
</html>
