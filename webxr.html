<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script>
      AFRAME.registerComponent('pickable', {
        schema: {
          hand: {type: 'selector'}
        },
        init: function () {
          this.el.addEventListener('gripdown', this.onGripDown.bind(this));
          this.originalParent = this.el.parentNode;
          this.originalPosition = this.el.getAttribute('position');
          this.originalRotation = this.el.getAttribute('rotation');
        },
        onGripDown: function () {
          const handPosition = new THREE.Vector3();
          this.data.hand.object3D.getWorldPosition(handPosition);
          const distance = this.el.object3D.position.distanceTo(handPosition);
          
          if (distance < 0.5) {  // If hand is close enough
            this.el.setAttribute('visible', true);
            this.data.hand.appendChild(this.el);
            this.el.setAttribute('position', '0 0 -0.25');
            this.el.setAttribute('rotation', '0 0 0');
          }
        },
        tick: function() {
          if (this.el.parentNode === this.originalParent) {
            this.el.setAttribute('position', this.originalPosition);
            this.el.setAttribute('rotation', this.originalRotation);
          }
        }
      });

      AFRAME.registerComponent('gun', {
        init: function () {
          this.shooting = false;
          this.el.addEventListener('triggerdown', this.onTriggerDown.bind(this));
          this.el.addEventListener('triggerup', this.onTriggerUp.bind(this));
        },
        onTriggerDown: function () {
          this.shooting = true;
          this.shoot();
        },
        onTriggerUp: function () {
          this.shooting = false;
        },
        shoot: function () {
          if (!this.shooting) return;
          this.el.emit('shoot');
          setTimeout(() => this.shoot(), 200);
        }
      });

      AFRAME.registerComponent('target', {
        init: function () {
          this.el.addEventListener('hit', function (evt) {
            this.setAttribute('visible', 'false');
            document.querySelector('#score').setAttribute('value', parseInt(document.querySelector('#score').getAttribute('value')) + 1);
            setTimeout(() => {
              this.setAttribute('visible', 'true');
            }, 2000);
          });
        }
      });

      AFRAME.registerComponent('bullet', {
        init: function () {
          this.el.addEventListener('collide', function (evt) {
            if (evt.detail.body.el.id === 'target') {
              evt.detail.body.el.emit('hit');
            }
            this.el.parentNode.removeChild(this.el);
          });
        }
      });

      AFRAME.registerComponent('sound-generator', {
        init: function () {
          this.audioContext = null;
          this.isInitialized = false;
          document.body.addEventListener('click', () => this.initAudio(), { once: true });
        },
        initAudio: function () {
          if (this.isInitialized) return;
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.isInitialized = true;
        },
        playShootSound: function () {
          if (!this.isInitialized) return;
          const oscillator = this.audioContext.createOscillator();
          oscillator.type = 'square';
          oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
          
          const gainNode = this.audioContext.createGain();
          gainNode.gain.setValueAtTime(1, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.2);
        },
        playHitSound: function () {
          if (!this.isInitialized) return;
          const oscillator = this.audioContext.createOscillator();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime);
          
          const gainNode = this.audioContext.createGain();
          gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.1);
        }
      });

      AFRAME.registerComponent('thumbstick-movement', {
        schema: {
          speed: {default: 0.1}
        },
        init: function () {
          this.velocity = new THREE.Vector3();
          this.axis = [0, 0];
        },
        tick: function (time, delta) {
          const { speed } = this.data;
          const rotation = this.el.object3D.rotation;
          const cameraEl = this.el.sceneEl.camera.el;
          const cameraRotation = cameraEl.object3D.rotation;

          // Apply camera Y rotation to movement
          const movementVector = new THREE.Vector3(this.axis[0], 0, this.axis[1]);
          movementVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraRotation.y);

          // Scale movement by speed and delta time
          movementVector.multiplyScalar(speed * (delta / 1000));

          // Update position
          this.el.object3D.position.add(movementVector);
        }
      });

      AFRAME.registerComponent('thumbstick-logging',{
        init: function () {
          this.el.addEventListener('thumbstickmoved', this.logThumbstick);
        },
        logThumbstick: function (evt) {
          if (evt.detail.y !== 0 || evt.detail.x !== 0) {
            console.log('Thumbstick moved: ', evt.detail.x, evt.detail.y);
          }
          this.components['thumbstick-movement'].axis = [evt.detail.x, evt.detail.y];
        }
      });
    </script>
  </head>
  <body>
    <a-scene physics="debug: true" sound-generator>
      <a-entity id="rig" position="0 1.6 0" thumbstick-movement="speed: 0.1" thumbstick-logging>
        <a-entity camera look-controls></a-entity>
        <a-entity id="leftHand" oculus-touch-controls="hand: left"></a-entity>
        <a-entity id="rightHand" oculus-touch-controls="hand: right"></a-entity>
      </a-entity>

      <a-entity id="table" position="0 0.5 -1">
        <a-box color="brown" width="1" depth="0.5" height="0.8"></a-box>
        <a-entity id="gun" gun pickable="hand: #rightHand" position="0 0.4 0">
          <a-box color="gray" depth="0.2" height="0.2" width="0.5"></a-box>
          <a-cylinder color="darkgray" radius="0.05" height="0.3" position="0 0 -0.25"></a-cylinder>
          <a-entity id="bulletSpawn" position="0 0 -0.4"></a-entity>
        </a-entity>
      </a-entity>

      <a-box id="target" class="raycastable" target position="0 1.6 -4" depth="0.5" height="0.5" width="0.5" color="red"></a-box>

      <a-plane position="0 0 -4" rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <a-text id="score" value="0" position="-0.75 1.5 -2"></a-text>

      <a-entity position="0 2.25 -15" particle-system="preset: snow; particleCount: 5000; size: 1"></a-entity>
    </a-scene>

    <script>
      var scene = document.querySelector('a-scene');
      var gun = document.querySelector('#gun');
      var bulletSpawn = document.querySelector('#bulletSpawn');
      var soundGenerator = scene.components['sound-generator'];

      gun.addEventListener('shoot', function () {
        var bullet = document.createElement('a-sphere');
        bullet.setAttribute('dynamic-body', '');
        bullet.setAttribute('bullet', '');
        bullet.setAttribute('radius', '0.05');
        bullet.setAttribute('color', 'black');
        bullet.setAttribute('class', 'raycastable');
        
        var pos = new THREE.Vector3();
        var rot = new THREE.Quaternion();
        bulletSpawn.object3D.getWorldPosition(pos);
        bulletSpawn.object3D.getWorldQuaternion(rot);

        bullet.setAttribute('position', pos);
        
        var direction = new THREE.Vector3(0, 0, -1);
        direction.applyQuaternion(rot);
        direction.multiplyScalar(30);

        bullet.setAttribute('velocity', direction);
        scene.appendChild(bullet);
        soundGenerator.playShootSound();
      });

      var target = document.querySelector('#target');
      target.addEventListener('hit', function () {
        soundGenerator.playHitSound();
      });
    </script>
  </body>
</html>
